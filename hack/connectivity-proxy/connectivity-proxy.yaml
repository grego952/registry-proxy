apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: connectivityproxies.connectivityproxy.sap.com
spec:
  group: connectivityproxy.sap.com
  names:
    kind: ConnectivityProxy
    plural: connectivityproxies
    shortNames:
      - cp
    singular: connectivityproxy
  scope: Namespaced
  versions:
    - additionalPrinterColumns:
        - jsonPath: .status.state
          name: STATE
          priority: 0
          type: string
      name: v1
      schema:
        openAPIV3Schema:
          properties:
            spec:
              properties:
                additionalCAs:
                  properties:
                    secretName:
                      type: string
                  required:
                    - secretName
                  type: object
                config:
                  properties:
                    highAvailabilityMode:
                      default: "off"
                      pattern: ^(off|path)$
                      type: string
                    integration:
                      default:
                        auditlog:
                          mode: console
                        connectivityService:
                          serviceCredentialsKey: service_key
                        provisioningService:
                          enabled: false
                      properties:
                        auditlog:
                          default:
                            mode: console
                          properties:
                            mode:
                              default: console
                              pattern: ^(console|service)$
                              type: string
                            serviceCredentialsKey:
                              type: string
                          required:
                            - mode
                          type: object
                        connectivityService:
                          default:
                            serviceCredentialsKey: service_key
                          properties:
                            serviceCredentialsKey:
                              default: service_key
                              type: string
                          required:
                            - serviceCredentialsKey
                          type: object
                        provisioningService:
                          default:
                            enabled: false
                          properties:
                            cache:
                              properties:
                                enabled:
                                  type: boolean
                              required:
                                - enabled
                              type: object
                            enabled:
                              default: false
                              type: boolean
                            serviceCredentialsKey:
                              type: string
                          required:
                            - enabled
                          type: object
                      required:
                        - auditlog
                        - connectivityService
                        - provisioningService
                      type: object
                    metrics:
                      properties:
                        dynatrace:
                          properties:
                            scrapePrometheusMetrics:
                              type: boolean
                          type: object
                        prometheus:
                          properties:
                            enabled:
                              type: boolean
                            jmxMetrics:
                              properties:
                                enabled:
                                  type: boolean
                              required:
                                - enabled
                              type: object
                            jvmMetrics:
                              properties:
                                enabled:
                                  type: boolean
                              required:
                                - enabled
                              type: object
                            port:
                              maximum: 65535.0
                              minimum: 1.0
                              type: integer
                          required:
                            - enabled
                          type: object
                      type: object
                    multiRegionMode:
                      default:
                        enabled: false
                      properties:
                        configMapName:
                          type: string
                        enabled:
                          default: false
                          type: boolean
                      required:
                        - enabled
                      type: object
                    servers:
                      properties:
                        businessDataTunnel:
                          properties:
                            externalHost:
                              type: string
                            externalPort:
                              default: 443
                              maximum: 65535.0
                              minimum: 1.0
                              type: integer
                            port:
                              maximum: 65535.0
                              minimum: 1.0
                              type: integer
                          required:
                            - externalHost
                            - externalPort
                          type: object
                        proxy:
                          default:
                            http:
                              enableProxyAuthorization: false
                              enabled: true
                              port: 20003
                            rfcAndLdap:
                              enableProxyAuthorization: false
                              enabled: true
                              port: 20001
                            socks5:
                              enableProxyAuthorization: false
                              enabled: true
                              port: 20004
                          properties:
                            authorization:
                              properties:
                                oauth:
                                  properties:
                                    allowedClientId:
                                      type: string
                                  required:
                                    - allowedClientId
                                  type: object
                              required:
                                - oauth
                              type: object
                            http:
                              default:
                                enableProxyAuthorization: false
                                enabled: true
                                port: 20003
                              properties:
                                allowRemoteConnections:
                                  type: boolean
                                enableProxyAuthorization:
                                  default: false
                                  type: boolean
                                enabled:
                                  default: true
                                  type: boolean
                                port:
                                  default: 20003
                                  maximum: 65535.0
                                  minimum: 1.0
                                  type: integer
                                suppressFailureOnMissingUserInfoInSapConnAuth:
                                  type: boolean
                              type: object
                            rfcAndLdap:
                              default:
                                enableProxyAuthorization: false
                                enabled: true
                                port: 20001
                              properties:
                                allowRemoteConnections:
                                  type: boolean
                                enableProxyAuthorization:
                                  default: false
                                  type: boolean
                                enabled:
                                  default: true
                                  type: boolean
                                port:
                                  default: 20001
                                  maximum: 65535.0
                                  minimum: 1.0
                                  type: integer
                              type: object
                            socks5:
                              default:
                                enableProxyAuthorization: false
                                enabled: true
                                port: 20004
                              properties:
                                allowRemoteConnections:
                                  type: boolean
                                enableProxyAuthorization:
                                  default: false
                                  type: boolean
                                enabled:
                                  default: true
                                  type: boolean
                                port:
                                  default: 20004
                                  maximum: 65535.0
                                  minimum: 1.0
                                  type: integer
                              type: object
                          type: object
                      required:
                        - businessDataTunnel
                        - proxy
                      type: object
                    serviceChannels:
                      default:
                        enabled: true
                      properties:
                        enabled:
                          default: true
                          type: boolean
                      required:
                        - enabled
                      type: object
                    subaccountId:
                      pattern: "^[a-zA-Z0-9-]+$"
                      type: string
                    subaccountSubdomain:
                      type: string
                    tenantMode:
                      default: dedicated
                      pattern: ^(dedicated|shared)$
                      type: string
                  required:
                    - integration
                    - servers
                    - tenantMode
                  type: object
                deployment:
                  default:
                    image:
                      registry: docker.io
                      repository: sapse/connectivity-proxy
                      tag: 2.11.0
                      pullPolicy: IfNotPresent
                    utilityImage:
                      registry: europe-docker.pkg.dev
                      repository: kyma-project/prod/connectivity-proxy/utility
                      tag: 0.0.1
                      pullPolicy: IfNotPresent
                    replicaCount: 1
                    resources:
                      maxFileDescriptorCount: 64000
                      limits:
                        cpu: 1000m
                        memory: 1024M
                      requests:
                        cpu: 100m
                        memory: 256M
                    restartWatcher:
                      enabled: true
                    autoscaling:
                      horizontal:
                        enabled: false
                  properties:
                    affinity:
                      properties:
                        podAntiAffinity:
                          properties:
                            topologyKey:
                              type: string
                          required:
                            - topologyKey
                          type: object
                      required:
                        - podAntiAffinity
                      type: object
                    autoscaling:
                      default:
                        horizontal:
                          enabled: false
                      properties:
                        horizontal:
                          default:
                            enabled: false
                          properties:
                            enabled:
                              default: false
                              type: boolean
                            maxReplicaCount:
                              minimum: 2.0
                              type: integer
                            metrics:
                              properties:
                                cpuAverageUtilization:
                                  type: integer
                                memoryAverageUtilization:
                                  type: integer
                              type: object
                          required:
                            - enabled
                          type: object
                          x-kubernetes-validations:
                            - message:
                                "When horizontal autoscaling is enabled, 'deployment.autoscaling.horizontal.maxReplicaCount'\
                                \ must be specified"
                              rule: "!(self.enabled == true) || has(self.maxReplicaCount)"
                            - message:
                                "When horizontal autoscaling is enabled, at least one of
                                'deployment.autoscaling.horizontal.metrics.cpuAverageUtilization' or
                                'deployment.autoscaling.horizontal.metrics.memoryAverageUtilization' must be specified"
                              rule:
                                "!(self.enabled == true) || has(self.metrics.cpuAverageUtilization)
                                || has(self.metrics.memoryAverageUtilization)"
                      type: object
                    image:
                      default:
                        registry: docker.io
                        repository: sapse/connectivity-proxy
                        tag: 2.11.0
                        pullPolicy: IfNotPresent
                      properties:
                        digest:
                          type: string
                        pullPolicy:
                          default: IfNotPresent
                          pattern: ^(Always|IfNotPresent|Never)$
                          type: string
                        pullSecret:
                          type: string
                        registry:
                          default: docker.io
                          type: string
                        repository:
                          default: sapse/connectivity-proxy
                          type: string
                        tag:
                          default: 2.11.0
                          type: string
                      required:
                        - registry
                        - repository
                        - tag
                      type: object
                    nodeSelector:
                      additionalProperties:
                        type: string
                      type: object
                    regionConfigurationsController:
                      properties:
                        resources:
                          properties:
                            limits:
                              properties:
                                cpu:
                                  type: string
                                memory:
                                  type: string
                              required:
                                - cpu
                                - memory
                              type: object
                            requests:
                              properties:
                                cpu:
                                  type: string
                                memory:
                                  type: string
                              required:
                                - cpu
                                - memory
                              type: object
                          required:
                            - limits
                          type: object
                      type: object
                    replicaCount:
                      default: 1
                      minimum: 1.0
                      type: integer
                    resources:
                      default:
                        maxFileDescriptorCount: 64000
                        limits:
                          cpu: 1000m
                          memory: 1024M
                        requests:
                          cpu: 100m
                          memory: 256M
                      properties:
                        limits:
                          default:
                            cpu: 1000m
                            memory: 1024M
                          properties:
                            cpu:
                              default: 1000m
                              type: string
                            memory:
                              default: 1024M
                              type: string
                          required:
                            - cpu
                            - memory
                          type: object
                        maxFileDescriptorCount:
                          default: 64000
                          minimum: 10.0
                          type: integer
                        requests:
                          default:
                            cpu: 100m
                            memory: 256M
                          properties:
                            cpu:
                              default: 100m
                              type: string
                            memory:
                              default: 256M
                              type: string
                          required:
                            - cpu
                            - memory
                          type: object
                      required:
                        - limits
                        - maxFileDescriptorCount
                      type: object
                    restartWatcher:
                      default:
                        enabled: true
                      properties:
                        enabled:
                          default: true
                          type: boolean
                      required:
                        - enabled
                      type: object
                    utilityImage:
                      default:
                        registry: europe-docker.pkg.dev
                        repository: kyma-project/prod/connectivity-proxy/utility
                        tag: 0.0.1
                        pullPolicy: IfNotPresent
                      properties:
                        digest:
                          type: string
                        pullPolicy:
                          default: IfNotPresent
                          pattern: ^(Always|IfNotPresent|Never)$
                          type: string
                        pullSecret:
                          type: string
                        registry:
                          default: europe-docker.pkg.dev
                          type: string
                        repository:
                          default: kyma-project/prod/connectivity-proxy/utility
                          type: string
                        tag:
                          default: 0.0.1
                          type: string
                      required:
                        - registry
                        - repository
                        - tag
                      type: object
                  required:
                    - image
                    - replicaCount
                    - resources
                    - utilityImage
                  type: object
                  x-kubernetes-validations:
                    - message: "'deployment.autoscaling.horizontal.maxReplicaCount' must be greater than 'deployment.replicaCount'"
                      rule:
                        "!(self.autoscaling.horizontal.enabled == true) || !has(self.autoscaling.horizontal.maxReplicaCount) ||
                        (self.autoscaling.horizontal.maxReplicaCount > self.replicaCount)"
                ingress:
                  default:
                    className: istio
                    timeouts:
                      proxy:
                        connect: 20
                        read: 120
                        send: 120
                  properties:
                    annotations:
                      additionalProperties:
                        type: string
                      type: object
                    className:
                      default: istio
                      pattern: ^(nginx|istio)$
                      type: string
                    istio:
                      properties:
                        gateway:
                          properties:
                            selector:
                              additionalProperties:
                                type: string
                              type: object
                          type: object
                        namespace:
                          type: string
                        tls:
                          properties:
                            ciphers:
                              items:
                                type: string
                              type: array
                          type: object
                      type: object
                    timeouts:
                      default:
                        proxy:
                          connect: 20
                          read: 120
                          send: 120
                      properties:
                        proxy:
                          default:
                            connect: 20
                            read: 120
                            send: 120
                          properties:
                            connect:
                              default: 20
                              type: integer
                            read:
                              default: 120
                              type: integer
                            send:
                              default: 120
                              type: integer
                          required:
                            - connect
                            - read
                            - send
                          type: object
                      type: object
                    tls:
                      properties:
                        secretName:
                          type: string
                      required:
                        - secretName
                      type: object
                  required:
                    - timeouts
                  type: object
                secretConfig:
                  default:
                    integration:
                      connectivityService:
                        secretName: connectivity-proxy-service-key
                  properties:
                    integration:
                      default:
                        connectivityService:
                          secretName: connectivity-proxy-service-key
                      properties:
                        auditlogService:
                          properties:
                            secretData:
                              pattern: "^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})$"
                              type: string
                            secretName:
                              type: string
                          required:
                            - secretName
                          type: object
                        connectivityService:
                          default:
                            secretName: connectivity-proxy-service-key
                          properties:
                            secretData:
                              pattern: "^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})$"
                              type: string
                            secretName:
                              default: connectivity-proxy-service-key
                              type: string
                          required:
                            - secretName
                          type: object
                        provisioningService:
                          properties:
                            secretData:
                              pattern: "^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})$"
                              type: string
                            secretName:
                              type: string
                          required:
                            - secretName
                          type: object
                      required:
                        - connectivityService
                      type: object
                  required:
                    - integration
                  type: object
              required:
                - config
                - deployment
                - ingress
                - secretConfig
              type: object
              x-kubernetes-validations:
                - message: "High availability mode 'off' is not compatible with horizontal autoscaling"
                  rule: "!(self.deployment.autoscaling.horizontal.enabled == true) || !(self.config.highAvailabilityMode == 'off')"
                - message: "High availability mode 'off' is not compatible with more than 1 Connectivity Proxy replica"
                  rule: "(self.deployment.replicaCount == 1) || !(self.config.highAvailabilityMode == 'off')"
            status:
              properties:
                observedGeneration:
                  type: integer
                state:
                  type: string
              type: object
          type: object
      served: true
      storage: true
      subresources:
        status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "connectivity-proxy-operator"
  namespace: "kyma-system"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "connectivity-proxy-operator-rbac"
rules:
  # CRD definitions
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["*"]
  # Connectivity Proxy custom resource
  - apiGroups: ["connectivityproxy.sap.com"]
    resources: ["connectivityproxies", "connectivityproxies/status"]
    verbs: ["*"]
  # main workload resources
  - apiGroups: [""]
    resources:
      ["deployments", "statefulsets", "services", "configmaps", "secrets"]
    verbs: ["*"]
  - apiGroups: ["apps"]
    resources:
      ["deployments", "statefulsets", "services", "configmaps", "secrets"]
    verbs: ["*"]
  # ServiceAccounts
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["*"]
  # Namespaces
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["create", "list", "get"]
  # Priorityclasses
  - apiGroups: ["scheduling.k8s.io"]
    resources: ["priorityclasses"]
    verbs: ["*"]
  # RBAC resources
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["roles", "clusterroles", "rolebindings", "clusterrolebindings"]
    verbs: ["*"]
  # Istio resources
  - apiGroups: ["networking.istio.io"]
    resources: ["gateways", "virtualservices", "destinationrules"]
    verbs: ["*"]
  - apiGroups: ["security.istio.io"]
    resources: ["peerauthentications"]
    verbs: ["*"]
  # SM resources
  - apiGroups: ["connectivityproxy.sap.com"]
    resources: ["servicemappings", "servicemappings/status"]
    verbs: ["*"]
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["validatingwebhookconfigurations"]
    verbs: ["*"]
  # SAP BTP Operator resources
  - apiGroups: ["services.cloud.sap.com"]
    resources: ["serviceinstances", "servicebindings"]
    verbs: ["*"]
  # Gardener Cert Management resources
  - apiGroups: ["cert.gardener.cloud"]
    resources: ["certificates"]
    verbs: ["*"]
  # Autoscaling
  - apiGroups: ["policy"]
    resources: ["poddisruptionbudgets"]
    verbs: ["*"]
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "connectivity-proxy-operator-rbac"
subjects:
  - kind: ServiceAccount
    name: "connectivity-proxy-operator"
    namespace: "kyma-system"
roleRef:
  kind: ClusterRole
  name: "connectivity-proxy-operator-rbac"
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: scheduling.k8s.io/v1
description:
  Scheduling priority of connectivity-proxy-operator. Must not be blocked by
  unschedulable user workloads.
globalDefault: false
kind: PriorityClass
metadata:
  name: connectivity-proxy-operator-priority-class
value: 2000000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "connectivity-proxy-operator"
  namespace: kyma-system
spec:
  selector:
    matchLabels:
      app: "connectivity-proxy-operator"
  template:
    metadata:
      labels:
        app: "connectivity-proxy-operator"
    spec:
      serviceAccountName: "connectivity-proxy-operator"
      priorityClassName: "connectivity-proxy-operator-priority-class"
      containers:
        - name: "connectivity-proxy-operator"
          image: "docker.io/sapse/connectivity-proxy-operator:2.13.2"
          imagePullPolicy: "Always"
          env:
            - name: START_APPLICATION
              value: "proxy-operator"
            - name: ENVIRONMENT
              value: "KYMA"
            - name: CONNECTIVITY_PROXY_DEFAULT_IMAGE_TAG
              value: "2.13.0"
          resources:
            requests:
              cpu: "100m"
              memory: "256M"
            limits:
              cpu: "1"
              memory: "1024M"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 30
            timeoutSeconds: 3
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: ui.connectivityproxy.sap.com
  namespace: kyma-system
  labels:
    app.kubernetes.io/name: connectivityproxies.connectivityproxy.sap.com
    busola.io/extension: resource
    busola.io/extension-version: "0.5"
data:
  details: |
    header: []
    body:
      - name: Summary
        widget: Panel
        children:
          - name: metadata.status
            source: status.state
  form: |
    - simple: true
      defaultExpanded: true
      path: spec.config.servers.proxy
      name: form.proxyConfig
      widget: FormGroup
      required: false
      children:
        - path: http.enabled
          name: form.proxyConfig.http.enable
          simple: true
          value:
            type: boolean
        - path: rfcAndLdap.enabled
          name: form.proxyConfig.rfcAndLdap.enable
          simple: true
          value:
            type: boolean
        - path: socks5.enabled
          name: form.proxyConfig.socks5.enable
          simple: true
          value:
            type: boolean
  general: |
    resource:
      kind: ConnectivityProxy
      group: connectivityproxy.sap.com
      version: v1
    name: Connectivity Proxies
    category: Custom Resources
    urlPath: connectivityproxies
    scope: namespace
  list: |
    - name: metadata.status
      source: status.state
  translations: |
    en:
      metadata.status: Status
      metadata.annotations: Annotations
      metadata.labels: Labels
      form.proxyConfig: Proxy configuration
      form.proxyConfig.http.enable: Enable the HTTP proxy
      form.proxyConfig.rfcAndLdap.enable: Enable the RFC and LDAP proxy
      form.proxyConfig.socks5.enable: Enable the SOCKS5 proxy
